"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function getPath(e){if(e.nodeType===Node.ATTRIBUTE_NODE)return getPath(e.ownerElement).concat([{name:e.nodeName}]);for(var t=0,n=e;null!=(n=n.previousSibling);)t++;var o=[];return o.push(t),e.parentNode&&e.parentNode.parentNode?getPath(e.parentNode).concat(o):o}function getNode(e,t){return e.reduce(function(e,t){return"number"==typeof t?e.childNodes[t]:e.attributes[t.name]},t)}function renderText(e,t){Placeholder.from(t).setTextContent(e)}function renderHtmlTemplate(e,t){Placeholder.from(t).setHtmlTemplateContent(e)}function renderHtmlTemplateCollection(e,t){Placeholder.from(t).setHtmlTemplateCollectionContent(e)}function renderTemplate(e,t){e instanceof HtmlTemplate?renderHtmlTemplate(e,t):e instanceof HtmlTemplateCollection?renderHtmlTemplateCollection(e,t):renderText(e,t)}function syncNode(e,t){var n=Placeholder.from(t),o=e.values;if(n.content&&n.content instanceof HtmlTemplateInstance){var a=n.content,l=a.template,i={childNodes:a.instance};if(l.nodeValueIndexArray){var r=l.nodeValueIndexArray.map(function(e){var t=getNode(getPath(e.node),i);if(t.parentNode&&"STYLE"===t.parentNode.nodeName.toUpperCase())return{node:t,valueIndexes:e.valueIndexes,nodeValue:e.nodeValue};if(t.nodeType===Node.ATTRIBUTE_NODE){var n=Marker.from(t),a=e.valueIndexes,l=t.nodeName,r=0===l.indexOf("on"),c=e.nodeValue;if(r){var s=a[0];n.attributes[l]=o[s];var u=l.substring(2,l.length);t.ownerElement.setAttribute(l,"return false;"),t.ownerElement.addEventListener(u,o[s])}else{var d=c,h=a.map(function(e){return o[e]});a.forEach(function(e,t){d=d.replace("\x3c!--"+e+"--\x3e",h[t])}),n.attributes[l]=d}return{node:t,valueIndexes:e.valueIndexes,nodeValue:e.nodeValue}}var m=Placeholder.from(t),p=o[e.valueIndexes];return p instanceof HtmlTemplate?(m.constructHtmlTemplateContent(p),syncNode(p,m.commentNode)):p instanceof HtmlTemplateCollection?(m.constructHtmlTemplateCollectionContent(p),syncNode(p,m.commentNode)):m.constructTextContent(),{node:t,valueIndexes:e.valueIndexes}});a.nodeValueIndexArray=r}}if(n.content&&n.content instanceof HtmlTemplateCollectionInstance){var c=n.content,s=c.template.templates;c.template.keys.forEach(function(e){var t=s[e],n=c.instance[e],o=Placeholder.from(n);null===o.content?t instanceof HtmlTemplate&&(o.constructHtmlTemplateContent(t.context.cache(t.key)),syncNode(t,n)):o.content instanceof HtmlTemplateInstance&&syncNode(t,n)})}}function render(e,t){if(renderTemplate(e,t),t.$synced||(syncNode(e,t),t.$synced=!0),"Promise"in window)return new Promise(function(t){setTimeout(function(){e.context.clearSyncCallbacks(),t()},300)});setTimeout(function(){e.context.clearSyncCallbacks()},300)}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),isChrome=!!window.chrome&&!!window.chrome.webstore,Context=function(){function e(){_classCallCheck(this,e),this._cache={},this._synccallbacks=[]}return _createClass(e,[{key:"hasCache",value:function(e){return e in this._cache}},{key:"cache",value:function(e,t){return this.hasCache(e)||(this._cache[e]=t),this._cache[e]}},{key:"html",value:function(){var e=this;return function(t){for(var n=arguments.length,o=Array(n>1?n-1:0),a=1;a<n;a++)o[a-1]=arguments[a];return new HtmlTemplate(t,o,e)}}},{key:"htmlCollection",value:function(){var e=this;return function(t,n,o){return new HtmlTemplateCollection(t,n,o,e)}}},{key:"addSyncCallback",value:function(e){this._synccallbacks.push(e)}},{key:"clearSyncCallbacks",value:function(){this._synccallbacks.forEach(function(e){e.apply()}),this._synccallbacks=[]}}]),e}(),cloneNodeDeep=function e(t){if(isChrome)return t.cloneNode(!0);for(var n=3==t.nodeType?document.createTextNode(t.nodeValue):t.cloneNode(!1),o=t.firstChild;o;)n.appendChild(e(o)),o=o.nextSibling;return n},Template=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"destroy",value:function(){console.log("WARNING NOT IMPLEMENTED YET ")}}]),e}(),TEMPLATE_ROOT={col:"colgroup",td:"tr",area:"map",tbody:"table",tfoot:"table",th:"tr",thead:"table",tr:"tbody",caption:"table",colgroup:"table",li:"ul"},HtmlTemplateCollectionInstance=function(e){function t(e,n){_classCallCheck(this,t);var o=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return o.template=e,o.placeholder=n,o.instance=null,o}return _inherits(t,Template),_createClass(t,[{key:"applyValues",value:function(e){var n=this;if(null===this.instance){this.instance={};var o=this.placeholder.commentNode;e.iterateRight(function(e,t,a){var l=Placeholder.from(document.createComment("placeholder-child"));o.parentNode.insertBefore(l.commentNode,o),renderTemplate(a,l.commentNode),o=l.firstChildNode(),n.instance[t]=l.commentNode})}else{e.iterateRight(),this.template.keys.forEach(function(t){if(e.keys.indexOf(t)<0){var o=n.instance[t];Placeholder.from(o).clearContent(),o.parentNode.removeChild(o),delete n.instance[t]}});var a=this.placeholder.commentNode;e.iterateRight(function(e,o,l){var i=n.instance[o];if(i){var r=Placeholder.from(i);r.content instanceof HtmlTemplateInstance?r.setHtmlTemplateContent(l):r.content instanceof t?r.setHtmlTemplateCollectionContent(l):r.setTextContent(l),a.previousSibling!=i&&(a.parentNode.insertBefore(i,a),r.validateInstancePosition()),a=r.firstChildNode()}else{var c=Placeholder.from(document.createComment("placeholder-child"));a.parentNode.insertBefore(c.commentNode,a),renderTemplate(l,c.commentNode),a=c.firstChildNode(),n.instance[o]=c.commentNode,n.template.context.addSyncCallback(function(){syncNode(l,c.commentNode)})}}),this.template=e}}},{key:"destroy",value:function(){var e=this;this.template.getKeys().forEach(function(t){var n=e.instance[t],o=Placeholder.from(n);o.content instanceof Template?o.content.destroy():o.content.parentNode.removeChild(o.content),n.parentNode.removeChild(n),delete e.instance[t]}),this.placeholder=null,this.instance=null,this.template=null}}]),t}(),HtmlTemplateInstance=function(e){function t(e,n){_classCallCheck(this,t);var o=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return o.template=e,o.placeholder=n,o.instance=[],o.nodeValueIndexArray=null,o}return _inherits(t,Template),_createClass(t,[{key:"applyValues",value:function(e){var t=e.values;if(null===this.instance||0===this.instance.length){HtmlTemplate.applyValues(t,this.template.nodeValueIndexArray);var n=this.template.documentFragment,o=cloneNodeDeep(n),a=this.placeholder.commentNode,l=o.childNodes[0],i=null;do{this.instance.push(l),i=l.nextSibling,a.parentNode.insertBefore(l,a)}while(l=i)}else this.nodeValueIndexArray&&HtmlTemplate.applyValues(t,this.nodeValueIndexArray)}},{key:"destroy",value:function(){this.instance.forEach(function(e){return e.parentNode.removeChild(e)}),this.nodeValueIndexArray=null,this.placeholder=null,this.template=null}}]),t}(),HtmlTemplateCollection=function(e){function t(e,n,o,a){_classCallCheck(this,t);var l=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return l.items=e,l.keyFn="string"==typeof n?function(e){return e[n]}:n,l.templateFn=o,l.context=a,l.keys=[],l.templates={},l.initialzed=!1,l}return _inherits(t,Template),_createClass(t,[{key:"iterateRight",value:function(e){if(this.initialzed)for(var t=this.keys.length-1;t>=0;){var n=this.items[t],o=this.keys[t],a=this.templates[o];e.apply(null,[n,o,a,t]),t--}else{for(var l=this.items.length-1;l>=0;){var i=this.items[l],r=this.keyFn.apply(this,[i,l]),c=this.templateFn.apply(this,[i,l]);e&&e.apply(null,[i,r,c,l]),l--,this.keys.push(r),this.templates[r]=c}this.initialzed=!0,this.keys.reverse()}}},{key:"getKeys",value:function(){if(!this.initialzed)throw new Error("Yikes its not initialized yet");return this.keys}},{key:"getTemplates",value:function(){if(!this.initialzed)throw new Error("Yikes its not initialized yet");return this.templates}}]),t}(),HtmlTemplate=function(e){function t(e,n,o){_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return a.strings=e,a.values=n,a.context=o,a.key=a.strings.join("").trim(),a.nodeValueIndexArray=null,a.documentFragment=null,a}return _inherits(t,Template),_createClass(t,[{key:"buildTemplate",value:function(e){this.documentFragment=this.getProperTemplateTag(e),this.nodeValueIndexArray=this.buildNodeValueIndex(this.documentFragment,[]),t.applyValues(this,this.nodeValueIndexArray)}},{key:"buildNodeValueIndex",value:function(e){var t=[],n=e.childNodes[0];if(void 0===n)return t;do{if(n.nodeType===Node.ELEMENT_NODE){for(var o=n.attributes,a=o.length,l=0;l<a;l++){var i=o[l].nodeValue,r=this.lookNodeValueArray(i);if(0!=r.length){var c=r.map(function(e){return e.match(/[\w\.]+/)[0]}).map(function(e){return parseInt(e)});c&&c.length>0&&t.push({node:o[l],valueIndexes:c,nodeValue:i})}}t=t.concat(this.buildNodeValueIndex(n))}if(n.nodeType===Node.TEXT_NODE&&"STYLE"===e.nodeName.toUpperCase()){var s=n.nodeValue,u=this.lookNodeValueArray(s);if(0==u.length)continue;var d=u.map(function(e){return e.match(/[\w\.]+/)[0]}).map(function(e){return parseInt(e)});d&&d.length>0&&t.push({node:n,valueIndexes:d,nodeValue:s})}if(n.nodeType===Node.COMMENT_NODE){var h=n.nodeValue;n.nodeValue="placeholder",t.push({node:n,valueIndexes:parseInt(h)})}}while(n=n.nextSibling);return t}},{key:"lookNodeValueArray",value:function(e){for(var t=[],n=e.indexOf("\x3c!--"),o=e.indexOf("--\x3e",n);o<e.length&&o>=0&&n>=0;)t.push(e.substring(n+4,o)),n=e.indexOf("\x3c!--",o+3),o=e.indexOf("--\x3e",n);return t}},{key:"getProperTemplateTag",value:function(e){var t=e.substring(1,e.indexOf(">"));t=(t.indexOf(" ")>0?t.substring(0,t.indexOf(" ")):t).toLowerCase();var n=TEMPLATE_ROOT[t];n=n||"div";var o=document.createElement(n);return o.innerHTML=e,o}},{key:"constructTemplate",value:function(){if(!this.context.hasCache(this.key)){var e=this.buildStringSequence();return this.buildTemplate(e),this.context.cache(this.key,this)}return this.context.cache(this.key)}},{key:"buildStringSequence",value:function(){return this.strings.reduce(function(e,t,n){return 0==n?t:e+"\x3c!--"+(n-1)+"--\x3e"+t},"").trim()}}],[{key:"applyValues",value:function(e,t){t&&t.forEach(function(t,n){var o=t.node,a=t.valueIndexes,l=o.nodeName;if(o.nodeType===Node.ATTRIBUTE_NODE){var i=Marker.from(o),r=0===l.indexOf("on"),c=t.nodeValue;if(r){var s=a[0];i.attributes[l]=e[s]}else{var u=c,d=a.map(function(t){return e[t]});if(a.forEach(function(e,t){u=u.replace("\x3c!--"+e+"--\x3e",d[t])}),o.ownerElement.setAttribute(l,u),l.indexOf(".bind")>=0){var h=l.substring(0,l.indexOf(".bind"));o.ownerElement.setAttribute(h,u)}i.attributes[l]=u}}if(o.nodeType===Node.TEXT_NODE){var m=t.nodeValue,p=a.map(function(t){return e[t]});a.forEach(function(e,t){m=m.replace("\x3c!--"+e+"--\x3e",p[t])}),o.nodeValue=m}if(o.nodeType===Node.COMMENT_NODE){o.nodeValue;renderTemplate(e[a],o)}})}}]),t}(),Marker=function(){function e(t){_classCallCheck(this,e),this.node=t,this.attributes={}}return _createClass(e,null,[{key:"from",value:function(t){var n=t;return t.nodeType===Node.ATTRIBUTE_NODE&&(n=t.ownerElement),n.$data=n.$data||new e(n),n.$data}}]),e}(),Placeholder=function(){function e(t){_classCallCheck(this,e),this.commentNode=t,this.content=null}return _createClass(e,[{key:"constructTextContent",value:function(){this.content=this.commentNode.previousSibling}},{key:"constructHtmlTemplateCollectionContent",value:function(e){var t=this;this.content=new HtmlTemplateCollectionInstance(e,this),this.content.instance={};var n=this.commentNode;e.iterateRight(function(e,o,a,l){do{n=n.previousSibling}while(n.nodeType!=Node.COMMENT_NODE&&"placeholder-child"!==n.nodeValue);t.content.instance[o]=n})}},{key:"constructHtmlTemplateContent",value:function(e){var t=e.documentFragment.childNodes.length;this.content=new HtmlTemplateInstance(e,this);for(var n=this.commentNode;t--;)n=n.previousSibling,this.content.instance.push(n);this.content.instance.reverse()}},{key:"setTextContent",value:function(e){this.content instanceof Text?this.content.nodeValue=e:(this.clearContent(),this.content=document.createTextNode(e),this.commentNode.parentNode.insertBefore(this.content,this.commentNode))}},{key:"setHtmlTemplateCollectionContent",value:function(e){var t=!1,n=this.content&&this.content instanceof HtmlTemplateCollectionInstance;null===this.content||n||(t=!(this.content instanceof Text&&"undefined"===this.content.nodeValue),this.clearContent()),this.content||(this.content=new HtmlTemplateCollectionInstance(e,this)),this.content.applyValues(e),t&&syncNode(this.content.template,this.commentNode)}},{key:"setHtmlTemplateContent",value:function(e){var t=!1,n=!!(this.content&&this.content instanceof HtmlTemplateInstance)&&this.content.template.key===e.key;if(null===this.content||n||(this.clearContent(),t=!0),!this.content){var o=e.constructTemplate();this.content=new HtmlTemplateInstance(o,this)}this.content.applyValues(e),t&&syncNode(this.content.template,this.commentNode)}},{key:"clearContent",value:function(){null!==this.content&&(this.content instanceof Template?this.content.destroy():this.content.parentNode.removeChild(this.content),this.content=null)}},{key:"hasEmptyContent",value:function(){return null===this.content}},{key:"firstChildNode",value:function(){if(this.content instanceof HtmlTemplateInstance)return this.content.instance[0];if(this.content instanceof HtmlTemplateCollectionInstance){var t=this.content.template.keys[0];return e.from(this.content.instance[t]).firstChildNode()}return this.content}},{key:"validateInstancePosition",value:function(){this.content instanceof HtmlTemplateInstance?this.content.instance.reduceRight(function(e,t){return e.previousSibling!=t&&e.parentNode.insertBefore(t,e),t},this.commentNode):this.content instanceof HtmlTemplateCollectionInstance||this.commentNode.previousSibling!=this.content&&this.commentNode.parentNode.insertBefore(this.content,this.commentNode)}}],[{key:"from",value:function(t){return t instanceof Comment?(t.$data=t.$data||new e(t),t.$data):(t.$placeholder||(t.$placeholder=document.createComment("placeholder"),t.appendChild(t.$placeholder)),e.from(t.$placeholder))}}]),e}();