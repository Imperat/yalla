"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function htmlMap(e,t,n){var a="string"==typeof t?function(e){return e[t]}:t;if("function"!=typeof a)throw new Error("Please provide keyFunction in htmlMap");return new HtmlTemplateCollections(a,n,e)}function html(e){for(var t=arguments.length,n=Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];return new HtmlTemplate(e,n)}function render(e,t){if(!t||!e)return void console.error("render(htmlTemplate,node) : htmlTemplate and node are mandatory");t.yallaTemplate?t.yallaTemplate.applyValues(e.templateValues):e.buildNodeTree().lookupDynamicNodes().appendChildrenTo(t).applyValues().saveTemplateToNode(t)}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),isTextNode=function(e){return 3===e.nodeType},isAttributeNode=function(e){return 2===e.nodeType},itIsNotInitialized=function(e){return!e.yallaTemplate},isMinimizationAttribute=function(e){return["checked","compact","declare","defer","disabled","ismap","noresize","noshade","nowrap","selected"].indexOf(e.nodeName)>=0},DATA_SEPARATOR="â†­",SEPARATOR="\x3c!--"+DATA_SEPARATOR+"--\x3e",_mapExistingNode={},HtmlTemplate=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];_classCallCheck(this,e),this.templateStatics=t,this.templateStaticString=t.join(SEPARATOR),this.templateValues=n}return _createClass(e,[{key:"buildNodeTree",value:function(){var e=null;return this.templateStaticString in _mapExistingNode?e=_mapExistingNode[this.templateStaticString]:(e=document.createElement("template"),e.innerHTML=this.templateStaticString,_mapExistingNode[this.templateStaticString]=e),this.nodeTree=Array.from(e.content.cloneNode(!0).childNodes),this}},{key:"lookupDynamicNodes",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.nodeTree,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(!t)throw new Error("nodeTree does not exist in HtmlTemplate probably you need to call buildNodeTree");return this.dynamicNodes=t.reduce(function(t,n){return n instanceof Comment&&n.textContent==DATA_SEPARATOR&&t.push(n),n.attributes&&(Array.from(n.attributes).reduce(function(e,t){if(t.nodeValue.indexOf(SEPARATOR)>=0)for(var n=t.nodeValue.split(SEPARATOR).length-1,a=0;a<n;a++)e.push(t);return e},t),e.lookupDynamicNodes(Array.from(n.childNodes),t)),t},n),this}},{key:"appendSiblingFrom",value:function(e){return this.nodeTree.forEach(function(t){return e.parentNode.insertBefore(t,e)}),this}},{key:"appendChildrenTo",value:function(e){return this.nodeTree.forEach(function(t){return e.appendChild(t)}),this}},{key:"applyValues",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.templateValues;return this.dynamicNodes.reduce(function(t,n,a){var i=t[a];return e._applyValue(n,i),t},t),this}},{key:"saveTemplateToNode",value:function(e){e.yallaTemplate=this}},{key:"destroy",value:function(){this.nodeTree.forEach(function(e){e instanceof Comment&&isTextNode(e.yallaTemplate)&&e.yallaTemplate.parentNode.removeChild(e.yallaTemplate),e.parentNode.removeChild(e)})}}],[{key:"_applyValue",value:function(t,n){isAttributeNode(t)?e._applyAttributeNode(t,n):e._applyComponentNode(t,n)}},{key:"_applyComponentNode",value:function(t,n){if((n=n||"")instanceof e)itIsNotInitialized(t)?n.buildNodeTree().lookupDynamicNodes().appendSiblingFrom(t).applyValues().saveTemplateToNode(t):t.yallaTemplate instanceof e?t.yallaTemplate.templateStaticString==n.templateStaticString?t.yallaTemplate.applyValues(n.templateValues):(t.yallaTemplate.destroy(),t.yallaTemplate=n.buildNodeTree().lookupDynamicNodes().appendSiblingFrom(t).applyValues()):(t.parentNode.removeChild(t.yallaTemplate),t.yallaTemplate=n.buildNodeTree().lookupDynamicNodes().appendSiblingFrom(t).applyValues());else if(n instanceof HtmlTemplateCollections)if(itIsNotInitialized(t))n.initializeCollections(t);else{if(!(t.yallaTemplate instanceof HtmlTemplateCollections))throw new Error("You seems to have different template !!");t.yallaTemplate.applyValues(n)}else e._applyTextToNode(n,t)}},{key:"_applyTextToNode",value:function(t,n){t=t||"";var a=document.createTextNode(t.toString());n.yallaTemplate&&isTextNode(n.yallaTemplate)&&n.parentNode.removeChild(n.yallaTemplate),n.yallaTemplate&&n.yallaTemplate instanceof e&&n.yallaTemplate.destroy(),n.parentNode.insertBefore(a,n),n.yallaTemplate=a}},{key:"_applyAttributeNode",value:function(e,t){"function"==typeof t&&0===e.name.indexOf("on")?(e.nodeValue=DATA_SEPARATOR,e.ownerElement[e.name]=t):(e.valueOriginal||(e.valueOriginal=e.value),e.value.indexOf(SEPARATOR)<0&&(e.value=e.valueOriginal),isMinimizationAttribute(e)?e.ownerElement[e.nodeName]=t:e.value=e.value.split(SEPARATOR).reduce(function(e,n,a){return 0==a?n:""+e+(1==a?t:SEPARATOR)+n},""))}}]),e}(),HtmlTemplateCollections=function(){function e(t,n,a){_classCallCheck(this,e),this.dictionary={},this.keyFunction=t,this.mapFunction=n,this.keyOrders=[],a.reduce(function(e,t,n,a){var i=e.templateCollections,l=e.keyFunction,o=e.mapFunction,r=e.orders,d=l.apply(e.templateCollections,[t,n,a]);return i.dictionary[d]=o.apply(i,[t,n,a]),i.dictionary[d]instanceof HtmlTemplate||(i.dictionary[d]=new HtmlTemplate([i.dictionary[d]],[])),r.push(d),e},{templateCollections:this,keyFunction:this.keyFunction,mapFunction:this.mapFunction,orders:this.keyOrders})}return _createClass(e,[{key:"initializeCollections",value:function(e){var t=this;this.keyOrders.forEach(function(n){t.dictionary[n].buildNodeTree().lookupDynamicNodes().appendSiblingFrom(e).applyValues()}),e.yallaTemplate=this,this.node=e}},{key:"applyValues",value:function(e){var t=this;this.keyOrders.filter(function(t){return e.keyOrders.indexOf(t)<0}).forEach(function(e){t.keyOrders.splice(t.keyOrders.indexOf(e),1);var n=t.dictionary;n[e].destroy(),delete n[e]}),e.keyOrders.reduceRight(function(e,t){var n=e.currentDict,a=e.newDict,i=e.node,l=a[t];return t in n?(l=n[t],l.applyValues(a[t].templateValues),l.nodeTree[l.nodeTree.length-1].nextSibling!=i&&l.nodeTree.forEach(function(e){return i.parentNode.insertBefore(e,i)}),e.node=l.nodeTree[0],a[t]=l):l.buildNodeTree().lookupDynamicNodes().appendSiblingFrom(i).applyValues(),e.node=l.nodeTree[0],e.node instanceof Comment&&e.node.yallaTemplate instanceof Text&&(e.node=e.node.yallaTemplate),e},{currentDict:this.dictionary,newDict:e.dictionary,keyOrderPos:this.keyOrders.map(function(t){return{key:t,pos:e.keyOrders.indexOf(t)}}).sort(function(e,t){return e.pos-t.pos}),node:this.node}),this.dictionary=e.dictionary,this.keyOrders=e.keyOrders}}]),e}();