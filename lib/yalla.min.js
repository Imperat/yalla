"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e,t){if("function"==typeof define&&define.amd)define([],t);else if("object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports)module.exports=t();else{var n=t(),o=n.Context,i=n.render;e.Context=o,e.render=i}}("undefined"!=typeof self?self:eval("this"),function(){function e(t){if(t.nodeType===Node.ATTRIBUTE_NODE)return e(t.ownerElement).concat([{name:t.nodeName}]);for(var n=0,o=t;null!=(o=o.previousSibling);)n++;var i=[];return i.push(n),t.parentNode&&t.parentNode.parentNode?e(t.parentNode).concat(i):i}function t(e,t){return e.reduce(function(e,t){return"number"==typeof t?e.childNodes[t]:e.attributes[t.name]},t)}function n(e,t){if(e===t)return!0;if(Array.isArray(e)&&Array.isArray(t)&&e.length==t.length){for(var n=!0,o=0;o<t.length;o++)if(!(n=n&&e[o]===t[o]))return!1;return!0}return!1}function o(e,t){C.from(t).setTextContent(e)}function i(e,t){C.from(t).setHtmlTemplateContent(e)}function r(e,t){C.from(t).setHtmlTemplateCollectionContent(e)}function a(e,t){e instanceof v?i(e,t):e instanceof y?r(e,t):o(e,t)}function s(n,o){var i=C.from(o),r=n.values;if(i.content&&i.content instanceof p){var a=i.content,l=a.template,c={childNodes:a.instance};if(l.nodeValueIndexArray){var u=l.nodeValueIndexArray.map(function(n){var o=n.nodeValue,i=n.valueIndexes,a=t(e(n.node),c),l=Array.isArray(i)?i.map(function(e){return r[e]}):r[i];if(a.parentNode&&"STYLE"===a.parentNode.nodeName.toUpperCase())return{node:a,valueIndexes:i,nodeValue:o,values:l};if(a.nodeType===Node.ATTRIBUTE_NODE){var u=N.from(a),d=a.nodeName;if(0===d.indexOf("on")){var h=i[0];u.attributes[d]=r[h];var f=d.substring(2,d.length);a.ownerElement.setAttribute(d,"return false;"),a.ownerElement.addEventListener(f,r[h])}else{var m=o,p=i.map(function(e){return r[e]});i.forEach(function(e,t){m=m.replace("\x3c!--"+e+"--\x3e",p[t])}),u.attributes[d]=m}return{node:a,valueIndexes:i,nodeValue:o,values:l}}var b=C.from(a),k=r[i];return k instanceof v?(b.constructHtmlTemplateContent(k),s(k,b.commentNode)):k instanceof y?(b.constructHtmlTemplateCollectionContent(k),s(k,b.commentNode)):b.constructTextContent(),{node:a,valueIndexes:i,values:l}});a.nodeValueIndexArray=u}}if(i.content&&i.content instanceof m){var d=i.content,h=d.template.templates;d.template.keys.forEach(function(e){var t=h[e],n=d.instance[e],o=C.from(n);null===o.content?t instanceof v&&(o.constructHtmlTemplateContent(t.context.cache(t.key)),s(t,n)):o.content instanceof p&&s(t,n)})}}var l=!!window.chrome&&!!window.chrome.webstore,c=function(){function e(){var t=this;_classCallCheck(this,e),this._cache={},this._synccallbacks=[],this.html=function(e){for(var n=arguments.length,o=Array(n>1?n-1:0),i=1;i<n;i++)o[i-1]=arguments[i];return new v(e,o,t)},this.htmlCollection=function(e,n,o){return new y(e,n,o,t)}}return _createClass(e,[{key:"hasCache",value:function(e){return e in this._cache}},{key:"cache",value:function(e,t){return this.hasCache(e)||(this._cache[e]=t),this._cache[e]}},{key:"addSyncCallback",value:function(e){this._synccallbacks.push(e)}},{key:"clearSyncCallbacks",value:function(){this._synccallbacks.forEach(function(e){e.apply()}),this._synccallbacks=[]}}]),e}(),u=function e(t){if(l)return t.cloneNode(!0);for(var n=3==t.nodeType?document.createTextNode(t.nodeValue):t.cloneNode(!1),o=t.firstChild;o;)n.appendChild(e(o)),o=o.nextSibling;return n},d=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"destroy",value:function(){console.log("WARNING NOT IMPLEMENTED YET ")}}]),e}(),h={col:"colgroup",td:"tr",area:"map",tbody:"table",tfoot:"table",th:"tr",thead:"table",tr:"tbody",caption:"table",colgroup:"table",li:"ul"},f=function(e){return["checked","compact","declare","defer","disabled","ismap","noresize","noshade","nowrap","selected"].indexOf(e.nodeName)>=0},m=function(e){function t(e,n){_classCallCheck(this,t);var o=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return o.template=e,o.placeholder=n,o.instance=null,o}return _inherits(t,d),_createClass(t,[{key:"applyValues",value:function(e){var t=this;if(null===this.instance){this.instance={};var n=this.placeholder.commentNode;e.iterateRight(function(e,o,i){var r=C.from(document.createComment("placeholder-child"));n.parentNode.insertBefore(r.commentNode,n),a(i,r.commentNode),n=r.firstChildNode(),t.instance[o]=r.commentNode})}else this.updateHtmlTemplateCollection(e)}},{key:"movePlaceholder",value:function(e,t,n){var o=e.commentNode,i=C.from(this.instance[n[t]]).firstChildNode();i&&(i.parentNode.insertBefore(o,i),e.validateInstancePosition())}},{key:"updateHtmlTemplateCollection",value:function(e){for(var t=this,n=e.items.length,o=this.template.keys.slice(0),i=o.slice(0),r=0,l=n-1,c=0,u=o.length-1,d=!0,h=e.items,f=[],m=null,p=null,y=[],v=[],N=[],b=[],k=0;k<n;k++){var x=d?r:l,_=d?c:u,T=h[x],g=e.keyFn.apply(null,[T,x,h]),E=e.templateFn.apply(null,[T,x,h]),O=o[_]!==g;O&&(o.indexOf(g)>=0?(this.movePlaceholder(C.from(this.instance[g]),d?_:_+1,o),o.splice(_,0,o.splice(o.indexOf(g),1)[0])):f.push({key:g,template:E,fromLeft:d,insertAfter:d?m:null,insertBefore:d?null:p})),d?(r++,c++,m=g,y.push(g),N.push(E)):(l--,u--,p=g,v.unshift(g),b.unshift(E)),d=O?!d:d,i.indexOf(g)>=0&&i.splice(i.indexOf(g),1)}e.keys=y.concat(v),e.templates=N.concat(b),e.initialzed=!0,i.forEach(function(e){C.from(t.instance[e]).clearContent(),delete t.instance[e],o.splice(o.indexOf(e),1)}),f.forEach(function(e){var n=C.from(document.createComment("placeholder-child")),i=e.fromLeft,r=e.insertAfter,l=e.insertBefore,c=e.key,u=e.template;if(i)if(r){var d=C.from(t.instance[r]).commentNode.nextSibling;d.parentNode.insertBefore(n.commentNode,d),a(u,n.commentNode),t.instance[c]=n.commentNode,o.splice(o.indexOf(r)+1,0,c)}else{var h=C.from(t.instance[o[0]]).firstChildNode();h.parentNode.insertBefore(n.commentNode,h),a(u,n.commentNode),t.instance[c]=n.commentNode,o.unshift(c)}else if(l){var f=C.from(t.instance[l]).firstChildNode();f.parentNode.insertBefore(n.commentNode,f),a(u,n.commentNode),t.instance[c]=n.commentNode,o.splice(o.indexOf(l),0,c)}else{var m=t.placeholder.commentNode;m.parentNode.insertBefore(n.commentNode,m),a(u,n.commentNode),t.instance[c]=n.commentNode,o.push(c)}t.template.context.addSyncCallback(function(){s(u,n.commentNode)})}),this.template=e}},{key:"destroy",value:function(){var e=this;this.template.getKeys().forEach(function(t){var n=e.instance[t],o=C.from(n);o.content instanceof d?o.content.destroy():o.content.parentNode.removeChild(o.content),n.parentNode.removeChild(n),delete e.instance[t]}),this.placeholder=null,this.instance=null,this.template=null}}]),t}(),p=function(e){function t(e,n){_classCallCheck(this,t);var o=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return o.template=e,o.placeholder=n,o.instance=[],o.nodeValueIndexArray=null,o}return _inherits(t,d),_createClass(t,[{key:"applyValues",value:function(e){if(null===this.instance||0===this.instance.length){v.applyValues(e,this.template.nodeValueIndexArray);var t=this.template.documentFragment,n=u(t),o=this.placeholder.commentNode,i=n.childNodes[0],r=null;do{this.instance.push(i),r=i.nextSibling,o.parentNode.insertBefore(i,o)}while(i=r)}else this.nodeValueIndexArray&&v.applyValues(e,this.nodeValueIndexArray)}},{key:"destroy",value:function(){this.instance.forEach(function(e){return e.parentNode.removeChild(e)}),this.nodeValueIndexArray=null,this.placeholder=null,this.template=null}}]),t}(),y=function(e){function t(e,n,o,i){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r.items=e,r.keyFn="string"==typeof n?function(e){return e[n]}:n,r.templateFn=o,r.context=i,r.keys=[],r.templates={},r.initialzed=!1,r}return _inherits(t,d),_createClass(t,[{key:"iterateRight",value:function(e){if(this.initialzed)for(var t=this.keys.length-1;t>=0;){var n=this.items[t],o=this.keys[t],i=this.templates[o];e&&e.apply(null,[n,o,i,t]),t--}else{for(var r=this.items.length-1;r>=0;){var a=this.items[r],s=this.keyFn.apply(this,[a,r]),l=this.templateFn.apply(this,[a,r]);e&&e.apply(null,[a,s,l,r]),r--,this.keys.push(s),this.templates[s]=l}this.initialzed=!0,this.keys.reverse()}}},{key:"getKeys",value:function(){if(!this.initialzed)throw new Error("Yikes its not initialized yet");return this.keys}},{key:"getTemplates",value:function(){if(!this.initialzed)throw new Error("Yikes its not initialized yet");return this.templates}}]),t}(),v=function(e){function t(e,n,o){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.strings=e,i.values=n,i.context=o,i.key=i.strings.join("").trim(),i.nodeValueIndexArray=null,i.documentFragment=null,i}return _inherits(t,d),_createClass(t,[{key:"buildTemplate",value:function(e){this.documentFragment=this.getProperTemplateTag(e),this.nodeValueIndexArray=this.buildNodeValueIndex(this.documentFragment,[]),t.applyValues(this,this.nodeValueIndexArray)}},{key:"buildNodeValueIndex",value:function(e){var t=[],n=e.childNodes[0];if(void 0===n)return t;do{if(n.nodeType===Node.ELEMENT_NODE){for(var o=n.attributes,i=o.length,r=0;r<i;r++){var a=o[r].nodeValue,s=this.lookNodeValueArray(a);if(0!=s.length){var l=s.map(function(e){return e.match(/[\w\.]+/)[0]}).map(function(e){return parseInt(e)});l&&l.length>0&&t.push({node:o[r],valueIndexes:l,nodeValue:a})}}t=t.concat(this.buildNodeValueIndex(n))}if(n.nodeType===Node.TEXT_NODE&&"STYLE"===e.nodeName.toUpperCase()){var c=n.nodeValue,u=this.lookNodeValueArray(c);if(0==u.length)continue;var d=u.map(function(e){return e.match(/[\w\.]+/)[0]}).map(function(e){return parseInt(e)});d&&d.length>0&&t.push({node:n,valueIndexes:d,nodeValue:c})}if(n.nodeType===Node.COMMENT_NODE){var h=n.nodeValue;n.nodeValue="placeholder",t.push({node:n,valueIndexes:parseInt(h)})}}while(n=n.nextSibling);return t}},{key:"lookNodeValueArray",value:function(e){for(var t=[],n=e.indexOf("\x3c!--"),o=e.indexOf("--\x3e",n);o<e.length&&o>=0&&n>=0;)t.push(e.substring(n+4,o)),n=e.indexOf("\x3c!--",o+3),o=e.indexOf("--\x3e",n);return t}},{key:"getProperTemplateTag",value:function(e){var t=e.substring(1,e.indexOf(">"));t=(t.indexOf(" ")>0?t.substring(0,t.indexOf(" ")):t).toLowerCase();var n=h[t];n=n||"div";var o=document.createElement(n);return o.innerHTML=e,o}},{key:"constructTemplate",value:function(){if(!this.context.hasCache(this.key)){var e=this.buildStringSequence();return this.buildTemplate(e),this.context.cache(this.key,this)}return this.context.cache(this.key)}},{key:"buildStringSequence",value:function(){return this.strings.reduce(function(e,t,n){return 0==n?t:e+"\x3c!--"+(n-1)+"--\x3e"+t},"").trim()}}],[{key:"applyValues",value:function(e,t){var o=e.values;t&&t.forEach(function(e,t){var i=e.node,r=e.valueIndexes,s=e.values,l=Array.isArray(r)?r.map(function(e){return o[e]}):o[r];if(!n(l,s)){var c=i.nodeName;if(i.nodeType===Node.ATTRIBUTE_NODE){var u=N.from(i),d=0===c.indexOf("on"),h=e.nodeValue;if(d){var m=r[0];u.attributes[c]=o[m]}else{var p=h,y=r.map(function(e){return o[e]});if(r.forEach(function(e,t){p=p.replace("\x3c!--"+e+"--\x3e",y[t])}),f(i)?(i.ownerElement[c]="true"==p.trim(),i.ownerElement.setAttribute(c,"")):i.ownerElement.setAttribute(c,p),c.indexOf(".bind")>=0){var v=c.substring(0,c.indexOf(".bind"));i.ownerElement.setAttribute(v,p)}u.attributes[c]=p}}if(i.nodeType===Node.TEXT_NODE){var C=e.nodeValue,b=r.map(function(e){return o[e]});r.forEach(function(e,t){C=C.replace("\x3c!--"+e+"--\x3e",b[t])}),i.nodeValue=C}if(i.nodeType===Node.COMMENT_NODE){i.nodeValue;a(o[r],i)}e.values=l}})}}]),t}(),N=function(){function e(t){_classCallCheck(this,e),this.node=t,this.attributes={}}return _createClass(e,null,[{key:"from",value:function(t){var n=t;return t.nodeType===Node.ATTRIBUTE_NODE&&(n=t.ownerElement),n.$data=n.$data||new e(n),n.$data}}]),e}(),C=function(){function e(t){_classCallCheck(this,e),this.commentNode=t,this.content=null}return _createClass(e,[{key:"constructTextContent",value:function(){this.content=this.commentNode.previousSibling}},{key:"constructHtmlTemplateCollectionContent",value:function(e){var t=this;this.content=new m(e,this),this.content.instance={};var n=this.commentNode;e.iterateRight(function(e,o,i,r){do{n=n.previousSibling}while(n.nodeType!=Node.COMMENT_NODE&&"placeholder-child"!==n.nodeValue);t.content.instance[o]=n})}},{key:"constructHtmlTemplateContent",value:function(e){var t=e.documentFragment.childNodes.length;this.content=new p(e,this);for(var n=this.commentNode;t--;)n=n.previousSibling,this.content.instance.push(n);this.content.instance.reverse()}},{key:"setTextContent",value:function(e){this.content instanceof Text?this.content.nodeValue=e:(this.clearContent(),this.content=document.createTextNode(e),this.commentNode.parentNode.insertBefore(this.content,this.commentNode))}},{key:"setHtmlTemplateCollectionContent",value:function(e){var t=!1,n=this.content&&this.content instanceof m;null===this.content||n||(t=!0,this.clearContent()),this.content||(this.content=new m(e,this)),this.content.applyValues(e),t&&s(this.content.template,this.commentNode)}},{key:"setHtmlTemplateContent",value:function(e){var t=!1,n=!!(this.content&&this.content instanceof p)&&this.content.template.key===e.key;if(null===this.content||n||(this.clearContent(),t=!0),!this.content){var o=e.constructTemplate();this.content=new p(o,this)}this.content.applyValues(e),t&&s(this.content.template,this.commentNode)}},{key:"clearContent",value:function(){null!==this.content&&(this.content instanceof d?this.content.destroy():this.content.parentNode.removeChild(this.content),this.content=null)}},{key:"hasEmptyContent",value:function(){return null===this.content}},{key:"firstChildNode",value:function(){if(this.content instanceof p)return this.content.instance[0];if(this.content instanceof m){var t=this.content.template.keys[0];return e.from(this.content.instance[t]).firstChildNode()}return this.content?this.content:this.commentNode}},{key:"validateInstancePosition",value:function(){this.content instanceof p?this.content.instance.reduceRight(function(e,t){return e.previousSibling!=t&&e.parentNode.insertBefore(t,e),t},this.commentNode):this.content instanceof m||this.commentNode.previousSibling!=this.content&&this.commentNode.parentNode.insertBefore(this.content,this.commentNode)}}],[{key:"from",value:function(t){return t instanceof Comment?(t.$data=t.$data||new e(t),t.$data):(t.$placeholder||(t.$placeholder=document.createComment("placeholder"),t.appendChild(t.$placeholder)),e.from(t.$placeholder))}}]),e}();return{Context:c,render:function(e,t){try{a(e,t)}catch(e){throw console.error(e.toString()),e}if(t.$synced||(s(e,t),t.$synced=!0),"Promise"in window)return new Promise(function(t){setTimeout(function(){e.context.clearSyncCallbacks(),t(!0)},300)});e.context.clearSyncCallbacks()}}});