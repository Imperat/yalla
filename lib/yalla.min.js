"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function htmlMap(e,t,a){var l="string"==typeof t?function(e){return e[t]}:t;if("function"!=typeof l)throw new Error("Please provide keyFunction in htmlMap");return new HtmlTemplateCollections(l,a,e)}function html(e){for(var t=arguments.length,a=Array(t>1?t-1:0),l=1;l<t;l++)a[l-1]=arguments[l];return new HtmlTemplate(e,a)}function render(e,t){if(!t||!e)return void console.error("render(htmlTemplate,node) : htmlTemplate and node are mandatory");t.yallaTemplate?t.yallaTemplate.applyValues(e.templateValues):e.buildNodeTree().lookupDynamicNodes().appendChildrenTo(t).applyValues().saveTemplateToNode(t)}var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var l=t[a];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(e,l.key,l)}}return function(t,a,l){return a&&e(t.prototype,a),l&&e(t,l),t}}(),isTextNode=function(e){return 3===e.nodeType},isAttributeNode=function(e){return 2===e.nodeType},itIsNotInitialized=function(e){return!e.yallaTemplate},isMinimizationAttribute=function(e){return["checked","compact","declare","defer","disabled","ismap","noresize","noshade","nowrap","selected"].indexOf(e.nodeName)>=0},DATA_SEPARATOR="â†­",SEPARATOR="\x3c!--"+DATA_SEPARATOR+"--\x3e",_mapExistingNode={},HtmlTemplate=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];_classCallCheck(this,e),this.templateStatics=t,this.templateStaticString=t.join(SEPARATOR),this.templateValues=a}return _createClass(e,[{key:"buildNodeTree",value:function(){var e=null;return this.templateStaticString in _mapExistingNode?e=_mapExistingNode[this.templateStaticString]:(e=document.createElement("template"),e.innerHTML=this.templateStaticString,_mapExistingNode[this.templateStaticString]=e),this.nodeTree=Array.from(e.content.cloneNode(!0).childNodes),this}},{key:"lookupDynamicNodes",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.nodeTree,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(!e)throw new Error("nodeTree does not exist in HtmlTemplate probably you need to call buildNodeTree");for(var a=0,l=e.length;a<l;a++){var n=e[a];if(n instanceof Comment&&n.textContent==DATA_SEPARATOR&&t.push(n),n.attributes){for(var i=Array.from(n.attributes),o=0,r=i.length;o<r;o++){var s=i[o];if(s.nodeValue.indexOf(SEPARATOR)>=0)for(var d=s.nodeValue.split(SEPARATOR).length-1,p=0;p<d;p++)t.push(s)}this.lookupDynamicNodes(Array.from(n.childNodes),t)}}return this.dynamicNodes=t,this}},{key:"appendSiblingFrom",value:function(e){for(var t=0,a=this.nodeTree.length;t<a;t++){var l=this.nodeTree[t];e.parentNode.insertBefore(l,e)}return this}},{key:"appendChildrenTo",value:function(e){for(var t=0,a=this.nodeTree.length;t<a;t++){var l=this.nodeTree[t];e.appendChild(l)}return this}},{key:"applyValues",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.templateValues,a=0,l=this.dynamicNodes.length;a<l;a++){var n=t[a],i=this.dynamicNodes[a];e._applyValue(i,n)}return this}},{key:"saveTemplateToNode",value:function(e){e.yallaTemplate=this}},{key:"destroy",value:function(){for(var e=0,t=this.nodeTree.length;e<t;e++){var a=this.nodeTree[e];a instanceof Comment&&isTextNode(a.yallaTemplate)&&a.yallaTemplate.parentNode.removeChild(a.yallaTemplate),a.parentNode.removeChild(a)}}}],[{key:"_applyValue",value:function(t,a){isAttributeNode(t)?e._applyAttributeNode(t,a):e._applyComponentNode(t,a)}},{key:"_applyComponentNode",value:function(t,a){if((a=a||"")instanceof e)itIsNotInitialized(t)?a.buildNodeTree().lookupDynamicNodes().appendSiblingFrom(t).applyValues().saveTemplateToNode(t):t.yallaTemplate instanceof e?t.yallaTemplate.templateStaticString==a.templateStaticString?t.yallaTemplate.applyValues(a.templateValues):(t.yallaTemplate.destroy(),t.yallaTemplate=a.buildNodeTree().lookupDynamicNodes().appendSiblingFrom(t).applyValues()):(t.parentNode.removeChild(t.yallaTemplate),t.yallaTemplate=a.buildNodeTree().lookupDynamicNodes().appendSiblingFrom(t).applyValues());else if(a instanceof HtmlTemplateCollections)if(itIsNotInitialized(t))a.initializeCollections(t);else{if(!(t.yallaTemplate instanceof HtmlTemplateCollections))throw new Error("You seems to have different template !!");t.yallaTemplate.applyValues(a)}else e._applyTextToNode(a,t)}},{key:"_applyTextToNode",value:function(t,a){t=t||"";var l=document.createTextNode(t.toString());a.yallaTemplate&&isTextNode(a.yallaTemplate)&&a.parentNode.removeChild(a.yallaTemplate),a.yallaTemplate&&a.yallaTemplate instanceof e&&a.yallaTemplate.destroy(),a.parentNode.insertBefore(l,a),a.yallaTemplate=l}},{key:"_applyAttributeNode",value:function(e,t){if("function"==typeof t&&0===e.name.indexOf("on"))e.nodeValue=DATA_SEPARATOR,e.ownerElement[e.name]=t;else if(e.valueOriginal||(e.valueOriginal=e.value),e.value.indexOf(SEPARATOR)<0&&(e.value=e.valueOriginal),isMinimizationAttribute(e))e.ownerElement[e.nodeName]=t;else{for(var a=e.value.split(SEPARATOR),l="",n=0,i=a.length;n<i;n++){var o=a[n];l=0==n?o:""+l+(1==n?t:SEPARATOR)+o}e.value=l}}}]),e}(),HtmlTemplateCollections=function(){function e(t,a,l){_classCallCheck(this,e),this.dictionary={},this.keyFunction=t,this.mapFunction=a,this.keyOrders=[];for(var n=0,i=l.length;n<i;n++){var o=l[n],r=this.keyFunction.apply(this,[o,n,l]);this.dictionary[r]=this.mapFunction.apply(this,[o,n,l]),this.dictionary[r]instanceof HtmlTemplate||(this.dictionary[r]=new HtmlTemplate([this.dictionary[r]],[])),this.keyOrders.push(r)}}return _createClass(e,[{key:"initializeCollections",value:function(e){for(var t=0,a=this.keyOrders.length;t<a;t++){var l=this.keyOrders[t];this.dictionary[l].buildNodeTree().lookupDynamicNodes().appendSiblingFrom(e).applyValues()}e.yallaTemplate=this,this.node=e}},{key:"applyValues",value:function(e){for(var t=[],a=0,l=this.keyOrders.length;a<l;a++){var n=this.keyOrders[a];if(e.keyOrders.indexOf(n)<0){var i=this.dictionary;i[n].destroy(),delete i[n]}else t.push(n)}this.keyOrders=t;for(var o=this.dictionary,r=e.dictionary,s=this.node,d=e.keyOrders.length-1;d>=0;d--){var p=e.keyOrders[d],u=r[p];if(p in o){if(u=o[p],u.applyValues(r[p].templateValues),u.nodeTree[u.nodeTree.length-1].nextSibling!=s)for(var m=0,y=u.nodeTree.length;m<y;m++){var c=u.nodeTree[m];s.parentNode.insertBefore(c,s)}s=u.nodeTree[0],r[p]=u}else u.buildNodeTree().lookupDynamicNodes().appendSiblingFrom(s).applyValues();s=u.nodeTree[0],s instanceof Comment&&s.yallaTemplate instanceof Text&&(s=s.yallaTemplate)}this.dictionary=e.dictionary,this.keyOrders=e.keyOrders}}]),e}();