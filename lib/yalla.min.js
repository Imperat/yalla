"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function findPreviousPlaceHolder(e){if(!e.previousSibling)return null;var t=e.previousSibling;return t instanceof Comment&&t.nodeValue==PLACEHOLDER_CONTENT?t:findPreviousPlaceHolder(t)}function syncTree(e,t){e.forEach(function(e,n){var o=t[n];if(e instanceof Comment&&e.nodeValue===PLACEHOLDER_CONTENT&&!e.$content){var a=o.$content;if(a instanceof HtmlTemplate){for(var r=a.nodeTree.length,i=[],l=e.previousSibling;r--;)i.push(l),l=l.previousSibling;e.$content=a.clone(i)}else if(a instanceof HtmlTemplateCollection){e.$content=a.clone();for(var s=a.keys.length,c=findPreviousPlaceHolder(e);s--;){var d=a.keys[s];e.$content.placeHolderContainer[d]=c,e.$content.templateValuesContainer[d]=c.$content,c=findPreviousPlaceHolder(c)}}else e.$content=e.previousSibling}else e.childNodes&&e.childNodes.length>0&&syncTree(arrayFrom(e.childNodes),arrayFrom(o.childNodes))})}function render(e,t){var n={then:function(e){n.successFn=e}};if(!t.$content){var o=document.createComment(PLACEHOLDER_CONTENT);t.appendChild(o),t.$content=o}return _render(e,t.$content),setTimeout(function(){_templateToUpdate.forEach(function(e){return e()}),_templateToUpdate=[],syncTree(_rootTree.cloneTree,_rootTree.baseTree),n.successFn&&n.successFn()},100),n}function destroy(e){e instanceof HtmlTemplate?e.destroy():e instanceof HtmlTemplateCollection?e.destroy():e.parentNode&&e.parentNode.removeChild(e)}function _render(e,t){e instanceof HtmlTemplate?_renderHtmlTemplate(e,t):e instanceof HtmlTemplateCollection?_renderHtmlTemplateCollection(e,t):_renderText(e,t)}function getFirstNodeFromTemplate(e,t){return e instanceof HtmlTemplate?e.nodeTree[0]:e instanceof HtmlTemplateCollection?getFirstNodeFromTemplate(e.templateValuesContainer[e.keys[0]],t):t.$content}function _renderHtmlTemplateCollection(e,t){var n={},o={},a=t.$content;a&&(a instanceof HtmlTemplateCollection?(o=a.placeHolderContainer,a.keys.forEach(function(t){e.keys.indexOf(t)<0&&removePlaceholder(o[t])})):(destroy(a),a=null)),e.keys.reduceRight(function(r,i){var l=e.templateValuesContainer[i],s=document.createComment(PLACEHOLDER_CONTENT);if(o[i]){s=o[i];var c=a.templateValuesContainer[i];c instanceof HtmlTemplate&&l instanceof HtmlTemplate&&c.key==l.key&&(e.templateValuesContainer[i]=c)}return s.nextSibling&&s.nextSibling==r||t.parentNode.insertBefore(s,r),n[i]=s,_render(l,s),getFirstNodeFromTemplate(e.templateValuesContainer[i],s)},t),e.placeHolderContainer=n,t.$content=e}function removePlaceholder(e){(e.$content instanceof HtmlTemplate||e.$content instanceof HtmlTemplateCollection)&&e.$content.destroy(),e.parentNode.removeChild(e)}function _buildTemplate(e,t){e.generateNodeTree(t).forEach(function(e){return t.parentNode.insertBefore(e,t)}),t.$content=e}function _renderHtmlTemplate(e,t){if(t.$content){var n=t.$content;n instanceof HtmlTemplate?(n.applyValues(e.values),n.nodeTree.reduceRight(function(e,t){return t.nextSibling&&t.nextSibling!=e&&e.parentNode&&e.parentNode.insertBefore(t,e),t},t)):(destroy(n),_buildTemplate(e,t))}else _buildTemplate(e,t)}function _renderText(e,t){if(null!=t.parentNode){var n=t.$content;if(n){if(n.nodeType&&n.nodeType===Node.TEXT_NODE){if(n.nodeValue===e)return;return void(n.nodeValue=e)}destroy(n)}var o=document.createTextNode(e);t.parentNode.insertBefore(o,t),t.$content=o}}function html(e){for(var t=e.join("").replace(/\s/g,""),n=arguments.length,o=Array(n>1?n-1:0),a=1;a<n;a++)o[a-1]=arguments[a];return new HtmlTemplate(e,o,t)}function cache(e){return{html:function(t){for(var n=arguments.length,o=Array(n>1?n-1:0),a=1;a<n;a++)o[a-1]=arguments[a];return new HtmlTemplate(t,o,e)}}}function htmlCollection(e,t,n){return new HtmlTemplateCollection(e,t,n)}function getPath(e){for(var t=0,n=e;null!=(n=n.previousSibling);)t++;var o=[];return o.push(t),e.parentNode&&e.parentNode.parentNode?o.concat(getPath(e.parentNode)):o}function getNode(e,t){return e.reduce(function(e,t){if("number"==typeof t)return e.childNodes[t];var n=e.attributes[t.name];return n.$dynamicAttributeLength=t.dynamicLength,n.$dynamicAttributeLengthPos=0,n},t)}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),PLACEHOLDER_CONTENT="placeholder",PLACEHOLDER="\x3c!--"+PLACEHOLDER_CONTENT+"--\x3e",isMinimizationAttribute=function(e){return["checked","compact","declare","defer","disabled","ismap","noresize","noshade","nowrap","selected"].indexOf(e.nodeName)>=0},templateRoot={col:"colgroup",td:"tr",area:"map",tbody:"table",tfoot:"table",th:"tr",thead:"table",tr:"tbody",caption:"table",colgroup:"table",li:"ul"},arrayFrom=function(e){for(var t=[],n=e.length;n--;t.unshift(e[n]));return t},_cache={},_templateToUpdate=[],_rootTree=[],HtmlTemplateCollection=function(){function e(t,n,o,a){_classCallCheck(this,e),this.items=t,this.keyFn="function"==typeof n?n:function(e){return e[n]},this.templateFn=o,this.keys=[],this.templateValuesContainer={},this.placeHolderContainer={},a||this._init()}return _createClass(e,[{key:"_init",value:function(){for(var e=this.items.length;e--;){var t=this.items[e],n=this.keyFn.apply(this,[t]);this.templateValuesContainer[n]=this.templateFn.apply(this,[t,e,this.items]),this.keys.push(n)}this.keys.reverse()}},{key:"destroy",value:function(){var e=this;this.keys.forEach(function(t){e.templateValuesContainer[t]instanceof HtmlTemplate&&(e.templateValuesContainer[t].destroy(),e.placeHolderContainer[t].parentNode.removeChild(e.placeHolderContainer[t]))}),this.keys=[],this.templateValuesContainer={},this.items={},this.placeHolderContainer={}}},{key:"clone",value:function(){var t=new e(this.items,this.keyFn,this.templateFn,!0);return t.keys=this.keys,t.templateValuesContainer={},t.placeHolderContainer={},t}}]),e}(),HtmlTemplate=function(){function e(t,n,o){_classCallCheck(this,e),this.strings=t,this.values=n,this.key=o}return _createClass(e,[{key:"generateNodeTree",value:function(t){var n=this,o=this.key;if(!_cache[o]){var a=this._getProperTemplateTag(this.strings.join(PLACEHOLDER).trim()),r=new e(this.strings,this.values,this.key);r.documentFragment=a;var i=[];r._lookDynamicNodes(arrayFrom(r.documentFragment.childNodes),i),r.dynamicNodes=i,_cache[o]=r}var l=_cache[o];return l.applyValues(this.values,!0),this.documentFragment=l.documentFragment.cloneNode(!0),this.nodeTree=arrayFrom(this.documentFragment.childNodes),_templateToUpdate.push(function(){n.dynamicNodesPath=l._generateDynamicNodesPath(),n.dynamicNodes=n._lookDynamicNodesFromPath({childNodes:n.nodeTree},n.dynamicNodesPath,!0),_rootTree={cloneTree:n.nodeTree,baseTree:l.documentFragment.childNodes}}),this.nodeTree}},{key:"_generateDynamicNodesPath",value:function(){return this.dynamicNodesPath||(this.dynamicNodesPath=this.dynamicNodes.map(function(e){return e.nodeType===Node.ATTRIBUTE_NODE?[{name:e.nodeName,dynamicLength:e.$dynamicAttributeLength}].concat(getPath(e.ownerElement)).reverse():getPath(e).reverse()})),this.dynamicNodesPath}},{key:"_getProperTemplateTag",value:function(e){var t=null,n=e.substring(1,e.indexOf(">"));n=(n.indexOf(" ")>0?n.substring(0,n.indexOf(" ")):n).toLowerCase();var o=templateRoot[n];return t=o?document.createElement(o):document.createElement("div"),t.innerHTML=e,t}},{key:"_lookDynamicNodesFromPath",value:function(e,t,n){var o=this;return t.map(function(t,a){var r=getNode(t,e);if(n&&(r.nodeType===Node.COMMENT_NODE&&(r.previousSibling instanceof Text?r.$content=r.previousSibling:(r.previousSibling,Comment)),r.nodeType===Node.ATTRIBUTE_NODE&&0===r.nodeName.indexOf("on"))){var i=r.nodeName.substring(2,r.nodeName.length);r.ownerElement.addEventListener(i,o.values[a])}return r})}},{key:"_lookDynamicNodes",value:function(e,t,n){var o=this;e.forEach(function(e){e instanceof Comment&&e.nodeValue==PLACEHOLDER_CONTENT?(t.push(e),n&&n.push(getPath(e))):e.attributes&&(arrayFrom(e.attributes).reduce(function(e,t){if(t.nodeValue.indexOf(PLACEHOLDER)>=0)for(var o=t.nodeValue.split(PLACEHOLDER).length-1,a=0;a<o;a++)if(t.$dynamicAttributeLength=o,t.$dynamicAttributeLengthPos=0,e.push(t),n){var r=[{name:t.nodeName,dynamicLength:o}].concat(getPath(t.ownerElement));n.push(r)}return e},t),o._lookDynamicNodes(arrayFrom(e.childNodes),t,n))})}},{key:"applyValues",value:function(t,n){this.dynamicNodes=this.dynamicNodes||[],this.dynamicNodes.forEach(function(o,a){o.nodeType===Node.ATTRIBUTE_NODE?e._applyAttributeNode(o,t[a],n):_render(t[a],o)})}},{key:"destroy",value:function(){this.nodeTree.forEach(function(e){return e.parentNode.removeChild(e)})}},{key:"clone",value:function(t){var n=this,o=new e(this.strings,this.values,this.key);return o.documentFragment=this.documentFragment,o.nodeTree=t,o.dynamicNodesPath=this.dynamicNodesPath,o.dynamicNodes=this._lookDynamicNodesFromPath({childNodes:t},this.dynamicNodesPath),o.dynamicNodes.forEach(function(e,t){if(e.nodeType===Node.ATTRIBUTE_NODE&&0===e.nodeName.indexOf("on")){var o=e.nodeName.substring(2,e.nodeName.length);e.ownerElement.addEventListener(o,n.values[t])}}),o}}],[{key:"_applyAttributeNode",value:function(e,t,n){if("function"==typeof t&&0===e.name.indexOf("on")){if(!n)return;e.nodeValue="false";var o=e.name.substring(2,e.name.length);e.ownerElement.addEventListener(o,t)}else e.$valueOriginal||(e.$valueOriginal=e.value),e.$dynamicAttributeLengthPos==e.$dynamicAttributeLength&&(e.$dynamicAttributeLengthPos=0),0==e.$dynamicAttributeLengthPos&&(e.$value=e.$valueOriginal),isMinimizationAttribute(e)?e.ownerElement[e.nodeName]=t:(e.$value=e.$value.split(PLACEHOLDER).reduce(function(e,n,o){return 0==o?n:""+e+(1==o?t:PLACEHOLDER)+n},""),e.$dynamicAttributeLengthPos++,e.$dynamicAttributeLengthPos==e.$dynamicAttributeLength&&e.value!=e.$value&&(e.value=e.$value))}}]),e}();